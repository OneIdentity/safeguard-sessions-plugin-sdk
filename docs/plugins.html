
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Plugin development &#8212; Safeguard for Privileged Sessions Plugin SDK 1.1.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Plugin-sdk services" href="services.html" />
    <link rel="prev" title="History of releases" href="history.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="services.html" title="Plugin-sdk services"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="history.html" title="History of releases"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Safeguard for Privileged Sessions Plugin SDK 1.1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="plugin-development">
<h1>Plugin development<a class="headerlink" href="#plugin-development" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#module-safeguard.sessions.plugin.aa_plugin" id="id2">AAPlugin</a><ul>
<li><a class="reference internal" href="#configuration-example" id="id3">Configuration example</a></li>
<li><a class="reference internal" href="#id1" id="id4">Plugin development</a><ul>
<li><a class="reference internal" href="#administrative-tasks" id="id5">Administrative tasks</a></li>
<li><a class="reference internal" href="#basic-functionality" id="id6">Basic functionality</a></li>
<li><a class="reference internal" href="#pre-defined-attributes-on-self" id="id7">Pre-defined attributes on self</a></li>
<li><a class="reference internal" href="#asking-the-end-user" id="id8">Asking the end-user</a></li>
<li><a class="reference internal" href="#using-cookies" id="id9">Using cookies</a></li>
<li><a class="reference internal" href="#setting-gateway-user-and-groups" id="id10">Setting gateway user and groups</a></li>
<li><a class="reference internal" href="#setting-additional-meta-data" id="id11">Setting additional meta data</a></li>
<li><a class="reference internal" href="#avoiding-costly-calculations" id="id12">Avoiding costly calculations</a></li>
<li><a class="reference internal" href="#adding-to-the-constructor" id="id13">Adding to the constructor</a></li>
<li><a class="reference internal" href="#authentication-cache" id="id14">Authentication cache</a></li>
<li><a class="reference internal" href="#aaplugin-internal-way-of-working" id="id15">AAPlugin internal way of working</a></li>
<li><a class="reference internal" href="#altering-the-steps" id="id16">Altering the steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#module-safeguard.sessions.plugin.plugin_response" id="id17">Plugin response</a></li>
<li><a class="reference internal" href="#module-safeguard.sessions.plugin.connection_info" id="id18">Connection information</a></li>
<li><a class="reference internal" href="#module-safeguard.sessions.plugin.plugin_base" id="id19">Plugin base functions</a></li>
<li><a class="reference internal" href="#details-of-aaplugin" id="id20">Details of AAPlugin</a></li>
</ul>
</div>
<div class="section" id="module-safeguard.sessions.plugin.aa_plugin">
<span id="aaplugin"></span><h2><a class="toc-backref" href="#id2">AAPlugin</a><a class="headerlink" href="#module-safeguard.sessions.plugin.aa_plugin" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-safeguard.sessions.plugin.aa_plugin"></span><p>The AA plugin skeleton enables rapid AA plugin development by providing a base class that implements common plugin
functionality that any plugin should possess. There are also helper functions and Python decorators for simplifying
frequent tasks.</p>
<p>The functionality that is implemented supports the requirements set out in the technical document
<em>Creating custom Authentication and Authorization plugins</em>, which can be found on the One Identity web site.</p>
<div class="section" id="configuration-example">
<h3><a class="toc-backref" href="#id3">Configuration example</a><a class="headerlink" href="#configuration-example" title="Permalink to this headline">¶</a></h3>
<p>The common plugin functionality can be configured by the following configuration options.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="c1">###### Common plugin options ######</span>
<span class="c1"># To enable or change a parameter, uncomment its line by removing the &#39;;&#39;</span>
<span class="c1"># character and replacing the right side of &#39;=&#39; with the desired value.</span>
<span class="c1"># If the parameter has the following structure</span>
<span class="c1"># ; name=&lt;value&gt;</span>
<span class="c1"># then the related feature is disabled until &#39;&lt;value&gt;&#39; is replaced.</span>
<span class="c1"># If the parameter has the following structure</span>
<span class="c1"># ; name=value</span>
<span class="c1"># then the parameter is automatically enabled with the default value of &#39;value&#39;.</span>

<span class="k">[auth]</span>
<span class="c1"># To override the prompt when using 2FA/MFA, enter the new prompt below.</span>
<span class="c1">; prompt=Press Enter for push notification or type one-time password:</span>

<span class="c1"># For better security, you can hide the characters (OTP or password) that the</span>
<span class="c1"># user types after the prompt.</span>
<span class="c1"># To hide the characters, set &#39;disable_echo&#39; to &#39;yes&#39;.</span>
<span class="c1">; disable_echo=yes</span>

<span class="k">[connection_limit by=client_ip_gateway_user]</span>
<span class="c1"># To limit the number of parallel sessions the gateway user can start from a</span>
<span class="c1"># given client IP address, configure &#39;limit&#39;. For an unlimited number of</span>
<span class="c1"># sessions, type &#39;0&#39;.</span>
<span class="c1">; limit=0</span>

<span class="c1">######[WHITELIST]######</span>
<span class="c1"># The &#39;whitelist source=user_list&#39; and &#39;whitelist source=ldap_server_group&#39;</span>
<span class="c1"># sections allow configuring authentication whitelists based on a User List</span>
<span class="c1"># policy or an LDAP Server policy. These two sections are independent, any of</span>
<span class="c1"># the two can be configured and can allow the user to bypass 2FA/MFA</span>
<span class="c1"># authentication.</span>

<span class="k">[whitelist source=user_list]</span>
<span class="c1"># The &#39;whitelist source=user_list&#39; section allows whitelisting users based on a</span>
<span class="c1"># User List policy configured in SPS (Policies -&gt; User Lists). To enable this</span>
<span class="c1"># whitelist, configure one of the use cases bellow.</span>
<span class="c1"># IMPORTANT: the user names are compared to the User List in a case sensitive</span>
<span class="c1"># manner.</span>

<span class="c1"># Use case #1: To allow specific users to connect without providing 2FA/MFA</span>
<span class="c1"># credentials, the User List policy should have the following settings.</span>
<span class="c1"># Set &#39;Allow&#39; to &#39;No user&#39; and list the users in &#39;Except&#39; list, finally set the</span>
<span class="c1"># &#39;name&#39; parameter here to the name of the User List policy.</span>
<span class="c1">; name=&lt;name-of-user-list-policy&gt;</span>

<span class="c1"># Use case #2: To enforce 2FA/MFA authentication for selected users, the User List</span>
<span class="c1"># policy should have the following settings. Set &#39;Allow&#39; to &#39;All users&#39; and</span>
<span class="c1"># list the users in &#39;Except&#39; list, finally set the &#39;name&#39; parameter here to the</span>
<span class="c1"># name of the User List policy.</span>
<span class="c1">; name=&lt;name-of-user-list-policy&gt;</span>

<span class="k">[whitelist source=ldap_server_group]</span>
<span class="c1"># The &#39;whitelist source=ldap_server_group&#39; section allows whitelisting users</span>
<span class="c1"># based on LDAP Server group membership, To enable this whitelist, configure one</span>
<span class="c1"># of the use cases bellow.</span>
<span class="c1"># IMPORTANT: the user names and groups are compared in LDAP in a case</span>
<span class="c1"># insensitive manner.</span>

<span class="c1"># Use case #1: To allow members of specific LDAP/AD group(s) to connect without</span>
<span class="c1"># providing 2FA/MFA credentials, type the names of these LDAP/AD groups as</span>
<span class="c1"># values of the &#39;except&#39; parameter and set &#39;allow&#39; parameter to &#39;no_user&#39;:</span>
<span class="c1">; allow=no_user</span>
<span class="c1">; except=&lt;group-1&gt;,&lt;group-2&gt;,...</span>

<span class="c1"># Use case #2: To enforce 2FA/MFA authentication only on members of specific</span>
<span class="c1"># LDAP/AD groups, type the names of these LDAP/AD groups as values of the</span>
<span class="c1"># &#39;except&#39; parameter and set &#39;allow&#39; parameter to &#39;all_users&#39;.</span>
<span class="c1">; allow=all_users</span>
<span class="c1">; except=&lt;group-1&gt;,&lt;group-2&gt;,...</span>

<span class="c1">######[USERMAPPING]######</span>
<span class="c1"># Usually gateway user and the external 2FA/MFA identity are different. Because</span>
<span class="c1"># the authentication is based on the 2FA/MFA identity, to be able to</span>
<span class="c1"># authenticate with the gateway user, you will have to map these two to each</span>
<span class="c1"># other. The following methods are possible: explicit, LDAP server.</span>
<span class="c1">#</span>
<span class="c1"># The explicit method has priority over the LDAP server method.</span>
<span class="c1"># If there is no [USERMAPPING] and no [username_transform], then the 2FA/MFA</span>
<span class="c1"># identity will be equal to the gateway user.</span>

<span class="k">[usermapping source=explicit]</span>
<span class="c1"># To map the gateway user name to an external 2FA/MFA identity, configure the</span>
<span class="c1"># following name-value pairs.</span>
<span class="c1"># NOTE: Type the user names in lowercase.</span>
<span class="c1">; &lt;user-name-1&gt;=&lt;id-1&gt;</span>
<span class="c1">; &lt;user-name-2&gt;=&lt;id-2&gt;</span>

<span class="k">[usermapping source=ldap_server]</span>
<span class="c1"># To map the gateway user name (that is in LDAP/AD and has a non-empty UTF8</span>
<span class="c1"># attribute string) to an external 2FA/MFA identity, configure the</span>
<span class="c1"># &#39;user_attribute&#39; parameter the following way:</span>
<span class="c1"># It must be an LDAP/AD user attribute that contains the external identity.</span>
<span class="c1"># Example: description, cn, mail. For a complete list consult</span>
<span class="c1"># https://docs.microsoft.com/en-gb/windows/desktop/ADSchema/c-user.</span>
<span class="c1"># IMPORTANT: you must configure the name of the LDAP/AD server policy in</span>
<span class="c1">#   [ldap_server] section.</span>
<span class="c1">; user_attribute=description</span>

<span class="k">[username_transform]</span>
<span class="c1"># If the 2FA/MFA service requires the use of domain name in the external</span>
<span class="c1"># 2FA/MFA identity, configure &#39;append_domain&#39;. This will append the domain name</span>
<span class="c1"># after the external 2FA/MFA identity with a &#39;@&#39; character. For example, if</span>
<span class="c1"># &#39;append_domain&#39; is set to &#39;foobar.com&#39;, then &#39;@foobar.com&#39; will be appended to</span>
<span class="c1"># the external identity.</span>
<span class="c1"># If you have configured [USERMAPPING], the [username_transform] process runs</span>
<span class="c1"># after the [usermapping] process.</span>
<span class="c1">; append_domain=&lt;domain-without-at-sign&gt;</span>

<span class="k">[ldap_server]</span>
<span class="c1"># Required if you have configured [whitelist source=ldap_server_group] or</span>
<span class="c1">#   [usermapping source=ldap_server].</span>
<span class="c1"># The name of the LDAP server policy (Policies &gt; LDAP Servers).</span>
<span class="c1">; name=&lt;name-of-LDAP-server-policy&gt;</span>

<span class="k">[credential_store]</span>
<span class="c1"># Name of the local credential store configured in SPS for hosting sensitive</span>
<span class="c1"># configuration data. For more information, read the &quot;Store sensitive</span>
<span class="c1"># plugin data securely&quot; section in the Tutorial.</span>
<span class="c1">; name=&lt;name-of-credential-store-policy-that-hosts-sensitive-data&gt;</span>

<span class="k">[logging]</span>
<span class="c1"># To configure the log level, enter one of the following values:</span>
<span class="c1">#   &#39;debug&#39;, &#39;info&#39;, &#39;warning&#39;, &#39;error&#39;, &#39;critical&#39;</span>
<span class="c1">; log_level=info</span>

<span class="k">[https_proxy]</span>
<span class="c1"># To set the HTTPS proxy environment for the plugin, configure the following.</span>
<span class="c1">; server=&lt;proxy-server-name-or-ip&gt;</span>
<span class="c1">; port=3128</span>

<span class="k">[question_1]</span>
<span class="c1"># IMPORTANT: To configure this optional section, contact our Support Team.</span>
<span class="c1"># To request additional information from the user (for example, ticket number)</span>
<span class="c1"># define one or more [question_] section (for example, [question_1],</span>
<span class="c1"># [question_2]). The user input will be stored under the value of &#39;key&#39; in the</span>
<span class="c1"># &#39;questions&#39; section of the session cookie.</span>
<span class="c1">; prompt=&lt;prompt-to-show-to-the-user&gt;</span>
<span class="c1">; key=&lt;target-key-for-the-answer&gt;</span>

<span class="c1"># For better security, you can hide the characters that the user types after the prompt.</span>
<span class="c1"># To hide the characters, set &#39;disable_echo&#39; to &#39;yes&#39;.</span>
<span class="c1">; disable_echo=yes</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id4">Plugin development</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Currently the easiest way to develop a plugin is to clone the pam plugins repo in <a class="reference external" href="https://git.balabit/pam/plugins.git">https://git.balabit/pam/plugins.git</a> .
There is an sps-skeleton plugin that can be copied and changed.</p>
<div class="section" id="administrative-tasks">
<h4><a class="toc-backref" href="#id5">Administrative tasks</a><a class="headerlink" href="#administrative-tasks" title="Permalink to this headline">¶</a></h4>
<p>Update the following files with information correct for your plugin:</p>
<p><code class="docutils literal"><span class="pre">MANIFEST</span></code>: plugin name, descriptions, etc.</p>
<p><code class="docutils literal"><span class="pre">Pipfile</span></code>: describes what additional Python3 PIP packages to package in the eventual plugin and also what packages to
use at development time. Note that the Plugin SDK should <em>not</em> be listed in the [packages] directive, as the Plugin SDK
is pre-installed on SPS, on the other hand make sure that the correct Plugin SDK version is selected in [dev-packages].</p>
<p><code class="docutils literal"><span class="pre">setup.py</span></code> (optional): not needed if the python code is organized such that the plugin’s root directory contains only
the ‘main.py’ and all other code is directly under a ‘lib’ directory. Otherwise it should enable installing the plugin
source code with <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span></code> command.</p>
<p>To create an installable ZIP file execute the command <code class="docutils literal"><span class="pre">make</span> <span class="pre">dist-&lt;plugin-folder&gt;</span></code> in the project root where
plugin-folder is your directory containing the plugin.</p>
<p>To create a Python virtual environment in order to run for example tests, execute <code class="docutils literal"><span class="pre">make</span> <span class="pre">venv-&lt;plugin-folder&gt;</span></code>, to
activate this virtual environment, execute <code class="docutils literal"><span class="pre">make</span> <span class="pre">shell</span></code>. Inside the shell one can use <code class="docutils literal"><span class="pre">pytest</span></code> command to run the
plugin tests.</p>
</div>
<div class="section" id="basic-functionality">
<h4><a class="toc-backref" href="#id6">Basic functionality</a><a class="headerlink" href="#basic-functionality" title="Permalink to this headline">¶</a></h4>
<p>In the <code class="docutils literal"><span class="pre">lib/plugin.py</span></code> file, there is a simple skeleton code. The methods <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authenticate()</span></code></a>,
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authorize()</span></code></a> and <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_session_ended()</span></code></a> are called by the AAPlugin base class after common
functionality is executed and parameters of the plugin invocation are pre-processed. All information about the
connection and pre-processing will be presented as attributes on <code class="docutils literal"><span class="pre">self</span></code> in these functions.</p>
<p>The expected return values are defined in the technical document <em>Creating custom Authentication and Authorization
plugins</em>. For simplicity one can use <a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a> class
to create the return value.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span><span class="p">,</span> <span class="n">AAResponse</span>

<span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">deny</span><span class="p">(</span><span class="s1">&#39;the reason to deny&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s1">&#39;the reason to accept&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_session_ended</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="pre-defined-attributes-on-self">
<h4><a class="toc-backref" href="#id7">Pre-defined attributes on self</a><a class="headerlink" href="#pre-defined-attributes-on-self" title="Permalink to this headline">¶</a></h4>
<p>The following attributes are available in all the above methods, except where otherwise noted.</p>
<p><a class="reference internal" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo" title="safeguard.sessions.plugin.connection_info.ConnectionInfo"><code class="xref py py-class docutils literal"><span class="pre">self.connection</span></code></a> which is a read-only object to show
a record of the SPS connection that is being processed. For example to find out the protocol used in the connection,
write <code class="docutils literal"><span class="pre">self.connection.protocol</span></code>. Note: only ‘session_id’ is available in
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended"><code class="xref py py-meth docutils literal"><span class="pre">do_session_ended</span></code></a> method. Also ‘target’ related values may not be available in
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">do_authenticate</span></code></a> method due to protocol/environmental reasons.</p>
<p><a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a> represents the cookie passed to and returned by the plugin.</p>
<p><a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.session_cookie</span></code></a> represents the session cookie passed to and returned by the
plugin.</p>
<p><a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.username"><code class="xref py py-attr docutils literal"><span class="pre">self.username</span></code></a> contains the effective (gateway) user name for this connection.</p>
<p><a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_identity</span></code></a> contains the identity to be used when contacting the MFA service.</p>
<p><a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_password" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_password"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_password</span></code></a> contains the password acquired from the user to be used in multi
factor authentication. <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_password" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_password"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_password</span></code></a> may contain empty string to indicate that
the user requires push notification. Note: only available in <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">do_authenticate</span></code></a> method.</p>
</div>
<div class="section" id="asking-the-end-user">
<h4><a class="toc-backref" href="#id8">Asking the end-user</a><a class="headerlink" href="#asking-the-end-user" title="Permalink to this headline">¶</a></h4>
<p>If the plugin needs extra information such as reponse to a challenge question, then the <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authenticate()</span></code></a>
method should return a value created by
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.need_info" title="safeguard.sessions.plugin.plugin_response.AAResponse.need_info"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.needinfo</span></code></a> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span><span class="p">,</span> <span class="n">AAResponse</span>

<span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;magic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">key_value_pairs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">needinfo</span><span class="p">(</span><span class="s2">&quot;What&#39;s the magic word?&quot;</span><span class="p">,</span> <span class="s2">&quot;magic&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">key_value_pairs</span><span class="p">[</span><span class="s1">&#39;magic&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;please&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">deny</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="using-cookies">
<h4><a class="toc-backref" href="#id9">Using cookies</a><a class="headerlink" href="#using-cookies" title="Permalink to this headline">¶</a></h4>
<p>It is possible to directly read and write <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a> dictionary. The contents will be
retained between invocations of the plugin.</p>
<p>It is also possible to add a cookie value on the fly when returning with a verdict from <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authenticate()</span></code></a>
or <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authorize()</span></code></a> by using the
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_cookie" title="safeguard.sessions.plugin.plugin_response.AAResponse.with_cookie"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.with_cookie</span></code></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span><span class="p">,</span> <span class="n">AAResponse</span>

<span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span><span class="o">.</span><span class="n">with_cookie</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">somekey</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>A more sophisticated way is to define attributes with the
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> decorator.</p>
<p>The same things apply to <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.session_cookie</span></code></a>.</p>
</div>
<div class="section" id="setting-gateway-user-and-groups">
<h4><a class="toc-backref" href="#id10">Setting gateway user and groups</a><a class="headerlink" href="#setting-gateway-user-and-groups" title="Permalink to this headline">¶</a></h4>
<p>In order to modify the gateway user and groups of the session from <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authenticate()</span></code></a>, use the
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_gateway_user" title="safeguard.sessions.plugin.plugin_response.AAResponse.with_gateway_user"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.with_gateway_user</span></code></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span><span class="p">,</span> <span class="n">AAResponse</span>

<span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span><span class="o">.</span><span class="n">with_gateway_user</span><span class="p">(</span><span class="s1">&#39;some-user&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-additional-meta-data">
<h4><a class="toc-backref" href="#id11">Setting additional meta data</a><a class="headerlink" href="#setting-additional-meta-data" title="Permalink to this headline">¶</a></h4>
<p>In order to set the additional meta data which is stored beside the session, use
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_additional_metadata" title="safeguard.sessions.plugin.plugin_response.AAResponse.with_additional_metadata"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.with_additional_metadata</span></code></a> method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span><span class="p">,</span> <span class="n">AAResponse</span>

<span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span><span class="o">.</span><span class="n">with_additional_metadata</span><span class="p">(</span><span class="s1">&#39;my data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="avoiding-costly-calculations">
<h4><a class="toc-backref" href="#id12">Avoiding costly calculations</a><a class="headerlink" href="#avoiding-costly-calculations" title="Permalink to this headline">¶</a></h4>
<p>To avoid redoing costly calculations or communication with external systems, it is advisable to store results of
such calculations in attributes decorated with
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> decorator. This might be necessary if
the plugin returns “need info” to SPS, thus starting a new instance and execution of the plugin when the reply arrives.</p>
</div>
<div class="section" id="adding-to-the-constructor">
<h4><a class="toc-backref" href="#id13">Adding to the constructor</a><a class="headerlink" href="#adding-to-the-constructor" title="Permalink to this headline">¶</a></h4>
<p>To enhance the class constructor, one should simply copy paste the <code class="xref py py-meth docutils literal"><span class="pre">__init__</span></code> function
and add new functionality. Do keep the original call to <code class="docutils literal"><span class="pre">super().__init__</span></code> at the top.</p>
</div>
<div class="section" id="authentication-cache">
<h4><a class="toc-backref" href="#id14">Authentication cache</a><a class="headerlink" href="#authentication-cache" title="Permalink to this headline">¶</a></h4>
<p>There is an authentication cache implemented, which allows bypassing the multi factor authentication if the client IP
address and gateway username matches the previous login inside a certain time frame. This is inherently unsafe as the
IP address can be spoofed and the attacker only needs to get the gateway password of the user.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[authentication_cache]</span>
<span class="c1">; hard_timeout=90</span>
<span class="c1">; soft_timeout=15</span>
<span class="c1">; reuse_limit=0</span>
</pre></div>
</div>
<p>Here <code class="docutils literal"><span class="pre">hard_timeout</span></code> is the maximum number of seconds that the cache is valid for. The <code class="docutils literal"><span class="pre">soft_timeout</span></code> can be
set to force re-authentication if the user does not reuse the cache quickly enough. And finally reuse limit is the
number of times the cache can be reused. The default for <code class="docutils literal"><span class="pre">reuse_limit</span></code> is 0, which means that the authentication
cache is turned off. In the example, if reuse limit is for example 10, and the user successfully authenticated with
multi factor authentication, then the next 10 authentication are bypassed in the next 90 seconds, provided that
there is no gap bigger than 15 seconds between them.</p>
</div>
<div class="section" id="aaplugin-internal-way-of-working">
<h4><a class="toc-backref" href="#id15">AAPlugin internal way of working</a><a class="headerlink" href="#aaplugin-internal-way-of-working" title="Permalink to this headline">¶</a></h4>
<p>When SPS calls the AAPlugin, it does so by creating an AAPlugin (or more likely derived class) instance. The
initialization of the instance processes the given plugin configuration and sets the logging level appropriately.</p>
<p>On the new AAPlugin instance SPS will make a call to <code class="docutils literal"><span class="pre">authenticate</span></code>, <code class="docutils literal"><span class="pre">authorize</span></code> or <code class="docutils literal"><span class="pre">session_ended</span></code>. In all cases
AAPlugin first collects the input parameters in
<a class="reference internal" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo" title="safeguard.sessions.plugin.connection_info.ConnectionInfo"><code class="xref py py-class docutils literal"><span class="pre">self.connection</span></code></a> and sets up
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a> and <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.session_cookie</span></code></a> attributes.</p>
<p>In case of <code class="docutils literal"><span class="pre">authenticate</span></code> the prescribed steps in <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin._authentication_steps()</span></code></a> are executed and if
that was successful then the steps in <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._post_successful_authentication_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._post_successful_authentication_steps"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin._post_successful_authentication_steps()</span></code></a> are also executed.
The later steps can ask further questions from the user and do other housekeeping tasks.</p>
<p>In case of <code class="docutils literal"><span class="pre">authorize</span></code> the prescribed steps in <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authorization_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._authorization_steps"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin._authorization_steps()</span></code></a> are executed, where the last
step is to call <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_authorize()</span></code></a>.</p>
<p>In case of <code class="docutils literal"><span class="pre">session_ended</span></code> the prescribed steps in <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._session_ended_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._session_ended_steps"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin._session_ended_steps()</span></code></a> are executed, where the last
step is to call <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended"><code class="xref py py-meth docutils literal"><span class="pre">AAPlugin.do_session_ended()</span></code></a>.</p>
<p>If a step returns with a verdict such as accept, deny or need info, then AAPlugin will add values stored in
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a> and <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.session_cookie</span></code></a> to the verdict
and return the result to SPS.</p>
<p>If a step returns with None, then AAPlugin marks it as done, and does not call it again in case the plugin returns
need info and the plugin is invoked again with the same callback.</p>
</div>
<div class="section" id="altering-the-steps">
<h4><a class="toc-backref" href="#id16">Altering the steps</a><a class="headerlink" href="#altering-the-steps" title="Permalink to this headline">¶</a></h4>
<p>The calls from SPS will be translated to discrete steps by <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin" title="safeguard.sessions.plugin.aa_plugin.AAPlugin"><code class="xref py py-class docutils literal"><span class="pre">AAPlugin</span></code></a>. It is possible to alter the list of
steps. For example to add <code class="docutils literal"><span class="pre">self.mystep</span></code> before <code class="xref py py-meth docutils literal"><span class="pre">do_authenticate()</span></code>, which is the last step:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_authentication_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_authentication_steps</span><span class="p">())</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mystep</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">steps</span>

        <span class="k">def</span> <span class="nf">mystep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>
</pre></div>
</div>
<p>For example to add a step called <code class="docutils literal"><span class="pre">self.mystep</span></code> before <code class="docutils literal"><span class="pre">self._transform_username</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_authentication_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_authentication_steps</span><span class="p">())</span>
            <span class="n">steps_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span>
            <span class="n">index_of_transform_username</span> <span class="o">=</span> <span class="n">steps_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_transform_username&#39;</span><span class="p">)</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index_of_transform_username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mystep</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">steps</span>

        <span class="k">def</span> <span class="nf">mystep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="module-safeguard.sessions.plugin.plugin_response">
<span id="plugin-response"></span><h2><a class="toc-backref" href="#id17">Plugin response</a><a class="headerlink" href="#module-safeguard.sessions.plugin.plugin_response" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-safeguard.sessions.plugin.plugin_response"></span><dl class="class">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse">
<em class="property">class </em><code class="descclassname">safeguard.sessions.plugin.plugin_response.</code><code class="descname">AAResponse</code><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a> class represents an AA plugin response and provides methods for creating and modifying such
responses.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAResponse</span>

<span class="k">class</span> <span class="nc">Plugin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway_user</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_on_whitelist</span><span class="p">(</span><span class="n">gateway_user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">is_on_blacklist</span><span class="p">(</span><span class="n">gateway_user</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">deny</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AAResponse</span><span class="o">.</span><span class="n">need_info</span><span class="p">(</span><span class="s2">&quot;Who are you?&quot;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="classmethod">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.accept">
<em class="property">classmethod </em><code class="descname">accept</code><span class="sig-paren">(</span><em>reason=None</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.accept" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new ACCEPT response.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>reason</strong> (<em>str</em>) – will be placed in the metadata as <code class="docutils literal"><span class="pre">{&quot;reason&quot;:</span> <span class="pre">reason}</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="classmethod">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.deny">
<em class="property">classmethod </em><code class="descname">deny</code><span class="sig-paren">(</span><em>reason=None</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.deny" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new DENY response.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>reason</strong> (<em>str</em>) – will be placed in the metadata as <code class="docutils literal"><span class="pre">{&quot;reason&quot;:</span> <span class="pre">reason}</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="classmethod">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.need_info">
<em class="property">classmethod </em><code class="descname">need_info</code><span class="sig-paren">(</span><em>question</em>, <em>key</em>, <em>echo_off=False</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.need_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new NEEDINFO response.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>question</strong> (<em>str</em>) – question (or prompt) to display for the user</li>
<li><strong>key</strong> (<em>str</em>) – identifier key for the response (this will key the response in <code class="docutils literal"><span class="pre">key_value_pairs</span></code> parameter)</li>
<li><strong>echo_off</strong> (<em>bool</em>) – turn echo off for the user input (useful for e.g. password input); default: False</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.with_additional_metadata">
<code class="descname">with_additional_metadata</code><span class="sig-paren">(</span><em>additional_metadata</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_additional_metadata" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the additional metadata field in the response. Overwrites previous reason given in <a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.accept" title="safeguard.sessions.plugin.plugin_response.AAResponse.accept"><code class="xref py py-meth docutils literal"><span class="pre">accept()</span></code></a>,
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.deny" title="safeguard.sessions.plugin.plugin_response.AAResponse.deny"><code class="xref py py-meth docutils literal"><span class="pre">deny()</span></code></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>additional_metadata</strong> – this value will be stored a JSON in the <em>Additional metadata</em> column of the meta
database.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.with_cookie">
<code class="descname">with_cookie</code><span class="sig-paren">(</span><em>cookie</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_cookie" title="Permalink to this definition">¶</a></dt>
<dd><p>Extend the response with a cookie.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>cookie</strong> (<em>dict</em>) – this value will be passed to the next call of the plugin in the <code class="docutils literal"><span class="pre">cookie</span></code> parameter</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.with_gateway_user">
<code class="descname">with_gateway_user</code><span class="sig-paren">(</span><em>gateway_user</em>, <em>gateway_groups=()</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_gateway_user" title="Permalink to this definition">¶</a></dt>
<dd><p>Extend the response with a gateway username and its groups.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>gateway_user</strong> (<em>str</em>) – this value will override the current gateway user</li>
<li><strong>gateway_groups</strong> (<em>seq</em>) – these will override the current gateway user’s groups; default: empty</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.plugin_response.AAResponse.with_session_cookie">
<code class="descname">with_session_cookie</code><span class="sig-paren">(</span><em>session_cookie</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_session_cookie" title="Permalink to this definition">¶</a></dt>
<dd><p>Extend the response with a session cookie.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>session_cookie</strong> (<em>dict</em>) – this value will be passed to other plugins’ (e.g. credstore) calls in their
<code class="docutils literal"><span class="pre">session_cookie</span></code> parameter</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse" title="safeguard.sessions.plugin.plugin_response.AAResponse"><code class="xref py py-class docutils literal"><span class="pre">AAResponse</span></code></a></td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-safeguard.sessions.plugin.connection_info">
<span id="connection-information"></span><h2><a class="toc-backref" href="#id18">Connection information</a><a class="headerlink" href="#module-safeguard.sessions.plugin.connection_info" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-safeguard.sessions.plugin.connection_info"></span><dl class="class">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo">
<em class="property">class </em><code class="descclassname">safeguard.sessions.plugin.connection_info.</code><code class="descname">ConnectionInfo</code><span class="sig-paren">(</span><em>session_id=None</em>, <em>protocol=None</em>, <em>connection_name=None</em>, <em>client_ip=None</em>, <em>client_port=None</em>, <em>gateway_user=None</em>, <em>target_username=None</em>, <em>key_value_pairs=None</em>, <em>gateway_groups=None</em>, <em>target_server=None</em>, <em>target_port=None</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo" title="safeguard.sessions.plugin.connection_info.ConnectionInfo"><code class="xref py py-class docutils literal"><span class="pre">ConnectionInfo</span></code></a> class gives easy access to the parameters passed to an AAA plugin. It is meant to
represent a read-only record of the SPS sessions being processed. It is also the means to pass many parameters
between functions if needed.</p>
<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.session_id">
<code class="descname">session_id</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.session_id" title="Permalink to this definition">¶</a></dt>
<dd><p>The unique identifier of the session.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.protocol">
<code class="descname">protocol</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.protocol" title="Permalink to this definition">¶</a></dt>
<dd><p>The protocol used in the connection, one of ssh, telnet, rdp.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.connection_name">
<code class="descname">connection_name</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.connection_name" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of the connection policy (&lt;protocol&gt; Control -&gt; Connections).</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.client_ip">
<code class="descname">client_ip</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.client_ip" title="Permalink to this definition">¶</a></dt>
<dd><p>A string containing the IP address of the client.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.client_port">
<code class="descname">client_port</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.client_port" title="Permalink to this definition">¶</a></dt>
<dd><p>The port number of the client.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.gateway_user">
<code class="descname">gateway_user</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.gateway_user" title="Permalink to this definition">¶</a></dt>
<dd><p>Contains the gateway username of the client, if already available (for example, if the user performed inband
gateway authentication), otherwise its value is None.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.target_username">
<code class="descname">target_username</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.target_username" title="Permalink to this definition">¶</a></dt>
<dd><p>The user name SPS uses to authenticate on the target server.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.key_value_pairs">
<code class="descname">key_value_pairs</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.key_value_pairs" title="Permalink to this definition">¶</a></dt>
<dd><p>A dictionary containing plugin-specific information, for example, it may include the username. This dictionary
also contains any key-value pairs that the user specified. In the plugin, such fields are already parsed into
separate key-value pairs.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.gateway_groups">
<code class="descname">gateway_groups</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.gateway_groups" title="Permalink to this definition">¶</a></dt>
<dd><p>The gateway groups of the gateway user as calculated by SPS.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.target_server">
<code class="descname">target_server</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.target_server" title="Permalink to this definition">¶</a></dt>
<dd><p>A string containing the IP address of the target server.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.connection_info.ConnectionInfo.target_port">
<code class="descname">target_port</code><a class="headerlink" href="#safeguard.sessions.plugin.connection_info.ConnectionInfo.target_port" title="Permalink to this definition">¶</a></dt>
<dd><p>The port number on the target server.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-safeguard.sessions.plugin.plugin_base">
<span id="plugin-base-functions"></span><h2><a class="toc-backref" href="#id19">Plugin base functions</a><a class="headerlink" href="#module-safeguard.sessions.plugin.plugin_base" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="safeguard.sessions.plugin.plugin_base.lazy_property">
<code class="descclassname">safeguard.sessions.plugin.plugin_base.</code><code class="descname">lazy_property</code><span class="sig-paren">(</span><em>factory</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_base.lazy_property" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.lazy_property" title="safeguard.sessions.plugin.plugin_base.lazy_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;lazy_property</span></code></a> decorator is used to mark attributes that should be only evaluated when
accessed. This is useful when the calculation of the attribute is heavy, but not always necessary.</p>
<p><strong>Usage</strong></p>
<p>To use <code class="docutils literal"><span class="pre">self.foobar</span></code> as a lazy property, simply define it on the Plugin class, and decorate it with
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.lazy_property" title="safeguard.sessions.plugin.plugin_base.lazy_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;lazy_property</span></code></a> decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span>
<span class="kn">from</span> <span class="nn">safeguard.sessions.plugin.plugin_base</span> <span class="kn">import</span> <span class="n">lazy_property</span>

<span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">calculate_answer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">need_foobar</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foobar</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="safeguard.sessions.plugin.plugin_base.cookie_property">
<code class="descclassname">safeguard.sessions.plugin.plugin_base.</code><code class="descname">cookie_property</code><span class="sig-paren">(</span><em>factory</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> decorator is used to mark attributes that should be passed in the
cookie between invocations of the same plugin. Setting up such property is an easy way to store and retrieve data
in <code class="docutils literal"><span class="pre">self.cookie</span></code>. Similarly to <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.lazy_property" title="safeguard.sessions.plugin.plugin_base.lazy_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;lazy_property</span></code></a> attributes, the evaulation of a
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> attribute is also delayed until usage.</p>
<p><strong>Usage</strong></p>
<p>To use <code class="docutils literal"><span class="pre">self.foobar</span></code> as a cookie property, simply define it on the Plugin class, and decorate it with
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span>
<span class="kn">from</span> <span class="nn">safeguard.sessions.plugin.plugin_base</span> <span class="kn">import</span> <span class="n">cookie_property</span>

<span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="nd">@cookie_property</span>
    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">foobar</span> <span class="o">==</span> <span class="mi">42</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foobar</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">do_authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">foobar</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The decorator <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> together with code in
<code class="xref py py-class docutils literal"><span class="pre">AAPlugin</span></code> will ensure that <code class="docutils literal"><span class="pre">foobar</span></code> is stored and retrieved from
the cookie passed to the plugin.</p>
<p>The initial definition of foobar is 42 in this case, but it can be any function - this function is only called
if foobar was not accessed before. To be more precise foobar is initialized with its factory function if it is
being accessed and it is not present in <code class="docutils literal"><span class="pre">self.cookie</span></code>.</p>
</dd></dl>

<dl class="function">
<dt id="safeguard.sessions.plugin.plugin_base.named_cookie_property">
<code class="descclassname">safeguard.sessions.plugin.plugin_base.</code><code class="descname">named_cookie_property</code><span class="sig-paren">(</span><em>key=None</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_base.named_cookie_property" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.named_cookie_property" title="safeguard.sessions.plugin.plugin_base.named_cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;named_cookie_property</span></code></a> decorator is working similarly to the
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> decorator.
The only difference is you can specify the key you want to save value in the <code class="docutils literal"><span class="pre">self.cookie</span></code>
It is important that you have to call the decorator with the desired key name, see usage.</p>
<p><strong>Usage</strong></p>
<p>To use <code class="docutils literal"><span class="pre">self.my_custom_key</span></code> as a cookie property, simply define it on the Plugin class, and decorate it with
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.named_cookie_property" title="safeguard.sessions.plugin.plugin_base.named_cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;named_cookie_property(key=my_custom_key)</span></code></a> decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span>
<span class="kn">from</span> <span class="nn">safeguard.sessions.plugin.plugin_base</span> <span class="kn">import</span> <span class="n">named_cookie_property</span>

<span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="nd">@named_cookie_property</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">my_custom_key</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span><span class="o">.</span><span class="n">my_custom_key</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="safeguard.sessions.plugin.plugin_base.session_cookie_property">
<code class="descclassname">safeguard.sessions.plugin.plugin_base.</code><code class="descname">session_cookie_property</code><span class="sig-paren">(</span><em>factory</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.plugin_base.session_cookie_property" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.session_cookie_property" title="safeguard.sessions.plugin.plugin_base.session_cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;session_cookie_property</span></code></a> decorator is used to mark attributes that should be
passed in the session cookie between invocations of all plugins relevant to the session.
Setting up such property is an easy way to store and retrieve data in <code class="docutils literal"><span class="pre">self.session_cookie</span></code>.
Similarly to <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.lazy_property" title="safeguard.sessions.plugin.plugin_base.lazy_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;lazy_property</span></code></a> attributes, the evaulation of a
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.session_cookie_property" title="safeguard.sessions.plugin.plugin_base.session_cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;session_cookie_property</span></code></a> attribute is also delayed until usage.</p>
<p><strong>Usage</strong></p>
<p>To use <code class="docutils literal"><span class="pre">self.foobar</span></code> as a session cookie property, simply define it on the Plugin class, and decorate it with
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.session_cookie_property" title="safeguard.sessions.plugin.plugin_base.session_cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;session_cookie_property</span></code></a> decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">safeguard.sessions.plugin</span> <span class="kn">import</span> <span class="n">AAPlugin</span>
<span class="kn">from</span> <span class="nn">safeguard.sessions.plugin.plugin_base</span> <span class="kn">import</span> <span class="n">session_cookie_property</span>

<span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">AAPlugin</span><span class="p">):</span>
    <span class="nd">@session_cookie_property</span>
    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">do_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">foobar</span> <span class="o">==</span> <span class="mi">42</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foobar</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">do_authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">foobar</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The decorator <a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.session_cookie_property" title="safeguard.sessions.plugin.plugin_base.session_cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;session_cookie_property</span></code></a> together with code in
<code class="xref py py-class docutils literal"><span class="pre">AAPlugin</span></code> will ensure that <code class="docutils literal"><span class="pre">foobar</span></code> is stored and retrieved from
the session cookie passed to the plugin.</p>
<p>The initial definition of foobar is 42 in this case, but it can be any function - this function is only called
if foobar was not accessed before. To be more precise foobar is initialized with its factory function if it is
being accessed and it is not present in <code class="docutils literal"><span class="pre">self.session_cookie</span></code>.</p>
</dd></dl>

</div>
<div class="section" id="details-of-aaplugin">
<h2><a class="toc-backref" href="#id20">Details of AAPlugin</a><a class="headerlink" href="#details-of-aaplugin" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin">
<em class="property">class </em><code class="descclassname">safeguard.sessions.plugin.aa_plugin.</code><code class="descname">AAPlugin</code><span class="sig-paren">(</span><em>configuration</em>, <em>defaults=None</em>, <em>logger=None</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin" title="safeguard.sessions.plugin.aa_plugin.AAPlugin"><code class="xref py py-class docutils literal"><span class="pre">AAPlugin</span></code></a> class implements the common functionality of AA plugins.</p>
<dl class="attribute">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie">
<code class="descname">cookie</code><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a> attribute is a dict that retains its contents between invocations of
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">do_authenticate()</span></code></a>, <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize"><code class="xref py py-meth docutils literal"><span class="pre">do_authorize()</span></code></a> and <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended"><code class="xref py py-meth docutils literal"><span class="pre">do_session_ended()</span></code></a>.
This is the way to pass data between these functions.</p>
<p>When the plugin returns the contents are automatically returned to SPS. Note that when
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_cookie" title="safeguard.sessions.plugin.plugin_response.AAResponse.with_cookie"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.with_cookie</span></code></a> is used, it
takes precedence and updates <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a> before returning to SPS.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie">
<code class="descname">session_cookie</code><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.session_cookie</span></code></a> is similar to <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.cookie</span></code></a>, but it is
also visible in other plugins in the same session. When the plugin returns the contents are automatically
returned to SPS. Note that when <a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.with_session_cookie" title="safeguard.sessions.plugin.plugin_response.AAResponse.with_session_cookie"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.with_session_cookie</span></code></a> is used, it takes precedence and
updates <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_cookie"><code class="xref py py-attr docutils literal"><span class="pre">self.session_cookie</span></code></a> before returning to SPS.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.username">
<code class="descname">username</code><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.username" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.username"><code class="xref py py-attr docutils literal"><span class="pre">self.username</span></code></a> is a
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> which is equal to the gateway
user name, or if not present, then the target user name, or finally the <code class="docutils literal"><span class="pre">username</span></code> value in the
<code class="docutils literal"><span class="pre">key_value_pairs</span></code>. If none of these are present then the connection is automatically denied as we don’t have
a user name to work with.</p>
<p>The initial value of <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.username"><code class="xref py py-attr docutils literal"><span class="pre">self.username</span></code></a> is calculated by <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_username"><code class="xref py py-meth docutils literal"><span class="pre">_extract_username()</span></code></a>. As a
cookie property, the value of <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.username"><code class="xref py py-attr docutils literal"><span class="pre">self.username</span></code></a> is retained in subsequent invocations of the
plugin.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity">
<code class="descname">mfa_identity</code><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity" title="Permalink to this definition">¶</a></dt>
<dd><p>The <code class="xref py py-attr docutils literal"><span class="pre">self.mfa_identity</span></code> is a
<a class="reference internal" href="#safeguard.sessions.plugin.plugin_base.cookie_property" title="safeguard.sessions.plugin.plugin_base.cookie_property"><code class="xref py py-meth docutils literal"><span class="pre">&#64;cookie_property</span></code></a> which is equal to
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.username"><code class="xref py py-attr docutils literal"><span class="pre">self.username</span></code></a> after mapping and transformations to the multi factor authentication
identity.</p>
<p>As a cookie property, the value of <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_identity</span></code></a> is retained in subsequent
invocations of the plugin.</p>
</dd></dl>

<dl class="attribute">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_password">
<code class="descname">mfa_password</code><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_password" title="Permalink to this definition">¶</a></dt>
<dd><p>The <code class="xref py py-attr docutils literal"><span class="pre">self.mfa_password</span></code> is read-only property that is implemented by <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password"><code class="xref py py-meth docutils literal"><span class="pre">_extract_mfa_password()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate">
<code class="descname">do_authenticate</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">do_authenticate()</span></code></a> method should verify that the given MFA identity (<code class="docutils literal"><span class="pre">self.mfa_identity</span></code>) matches the
given MFA password (<code class="docutils literal"><span class="pre">self.mfa_password</span></code>). In case the password is an empty string, the check should do a
challenge-response or push notification or some other check. For details consult the <em>Creating custom
Authentication and Authorization plugins</em> technical document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">dict with at least the key ‘verdict’ to indicate ‘ACCEPT’, ‘DENY’ or ‘NEEDINFO’</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize">
<code class="descname">do_authorize</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize"><code class="xref py py-meth docutils literal"><span class="pre">do_authorize()</span></code></a> method should verify that the given MFA identity (<code class="docutils literal"><span class="pre">self.mfa_identity</span></code>)
has authority (has the right) to access the given target asset (<code class="docutils literal"><span class="pre">self.connection.target_user</span></code>,
<code class="docutils literal"><span class="pre">self.connection.target_server</span></code>, etc). For details consult the <em>Creating custom Authentication and
Authorization plugins</em> technical document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">dict with at least the key ‘verdict’ to indicate ‘ACCEPT’, ‘DENY’.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended">
<code class="descname">do_session_ended</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended"><code class="xref py py-meth docutils literal"><span class="pre">do_session_ended()</span></code></a> hook can be used to send a log message related to the entire session or close the
ticket related to the session if the plugin interacts with a ticketing system. For details consult the
<em>Creating custom Authentication and Authorization plugins</em> technical document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">None</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps">
<code class="descname">_authentication_steps</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps"><code class="xref py py-meth docutils literal"><span class="pre">_authentication_steps()</span></code></a> function returns a list of other functions to be called to execute the
authentication task. The default implementation is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_authentication_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :meth:`_authentication_steps` function returns a list of other functions to be called to execute the</span>
<span class="sd">        authentication task. The default implementation is as follows:</span>

<span class="sd">        .. literalinclude:: ../../src/safeguard/sessions/plugin/aa_plugin.py</span>
<span class="sd">            :pyobject: AAPlugin._authentication_steps</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_username</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_user_list_whitelist</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_ldap_group_whitelist</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_authentication_cache</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_username_explicit</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_username_ldap</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_username</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ask_mfa_password</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_authenticate</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._post_successful_authentication_steps">
<code class="descname">_post_successful_authentication_steps</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._post_successful_authentication_steps" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._post_successful_authentication_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._post_successful_authentication_steps"><code class="xref py py-meth docutils literal"><span class="pre">_post_successful_authentication_steps()</span></code></a> function returns a list of other functions to call be called
after <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._authentication_steps"><code class="xref py py-meth docutils literal"><span class="pre">_authentication_steps()</span></code></a> in case of successful authentication. The functions listed here may only
return <code class="docutils literal"><span class="pre">None</span></code> or a needinfo reply. The default implementation is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_post_successful_authentication_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :meth:`_post_successful_authentication_steps` function returns a list of other functions to call be called</span>
<span class="sd">        after :meth:`_authentication_steps` in case of successful authentication. The functions listed here may only</span>
<span class="sd">        return ``None`` or a needinfo reply. The default implementation is as follows:</span>

<span class="sd">        .. literalinclude:: ../../src/safeguard/sessions/plugin/aa_plugin.py</span>
<span class="sd">            :pyobject: AAPlugin._post_successful_authentication_steps</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_authentication_cache</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ask_questions</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._authorization_steps">
<code class="descname">_authorization_steps</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authorization_steps" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._authorization_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._authorization_steps"><code class="xref py py-meth docutils literal"><span class="pre">_authorization_steps()</span></code></a> function returns a list of other functions to call to finish the authentication
task. The default implementation is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_authorization_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :meth:`_authorization_steps` function returns a list of other functions to call to finish the authentication</span>
<span class="sd">        task. The default implementation is as follows:</span>

<span class="sd">        .. literalinclude:: ../../src/safeguard/sessions/plugin/aa_plugin.py</span>
<span class="sd">            :pyobject: AAPlugin._authorization_steps</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_increase_client_connection_count</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_authorize</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._session_ended_steps">
<code class="descname">_session_ended_steps</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._session_ended_steps" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._session_ended_steps" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._session_ended_steps"><code class="xref py py-meth docutils literal"><span class="pre">_session_ended_steps()</span></code></a> function returns a list of other functions to call to finish the session_ended
task. The functions in the list must return with None. The default implementation is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_session_ended_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :meth:`_session_ended_steps` function returns a list of other functions to call to finish the session_ended</span>
<span class="sd">        task. The functions in the list must return with None. The default implementation is as follows:</span>

<span class="sd">        .. literalinclude:: ../../src/safeguard/sessions/plugin/aa_plugin.py</span>
<span class="sd">            :pyobject: AAPlugin._session_ended_steps</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decrease_client_connection_count</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_session_ended</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_username">
<code class="descname">_extract_username</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_username" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_username"><code class="xref py py-meth docutils literal"><span class="pre">_extract_username()</span></code></a> method may be overridden to modify the calculation of the gateway username. For
example to introduce a new key_value_pair that can be the source of the username.</p>
<p>If this method returns None, then AAPlugin automatically denies the connection.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">str or None</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_explicit">
<code class="descname">_map_username_explicit</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_explicit" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_explicit" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_explicit"><code class="xref py py-meth docutils literal"><span class="pre">_map_username_explicit()</span></code></a> method is implementing the <code class="docutils literal"><span class="pre">[usermapping</span> <span class="pre">source=explicit]</span></code> section in the
configuration. It may alter the value of <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_identity</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_ldap">
<code class="descname">_map_username_ldap</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_ldap" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_ldap" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._map_username_ldap"><code class="xref py py-meth docutils literal"><span class="pre">_map_username_ldap()</span></code></a> method is implementing the <code class="docutils literal"><span class="pre">[usermapping</span> <span class="pre">source=ldap_server]</span></code> section in the
configuration. It may alter the value of <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_identity</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._transform_username">
<code class="descname">_transform_username</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._transform_username" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._transform_username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._transform_username"><code class="xref py py-meth docutils literal"><span class="pre">_transform_username()</span></code></a> method is implementing the <code class="docutils literal"><span class="pre">[username_transform]</span></code> section in the
configuration. It may alter the value of <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.mfa_identity"><code class="xref py py-attr docutils literal"><span class="pre">self.mfa_identity</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._check_username">
<code class="descname">_check_username</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._check_username" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._check_username" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._check_username"><code class="xref py py-meth docutils literal"><span class="pre">_check_username()</span></code></a> method checks that the plugin received a user identity to work with. It should
return <a class="reference internal" href="#safeguard.sessions.plugin.plugin_response.AAResponse.deny" title="safeguard.sessions.plugin.plugin_response.AAResponse.deny"><code class="xref py py-meth docutils literal"><span class="pre">AAResponse.deny</span></code></a> verdict if there
is no username, otherwise None.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password">
<code class="descname">_extract_mfa_password</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password"><code class="xref py py-meth docutils literal"><span class="pre">_extract_mfa_password()</span></code></a> method returns the value of <code class="docutils literal"><span class="pre">self.connection.key_value_pairs['otp']</span></code>. The
value is either specified as part of the user name or if not, then AAPlugin will ask the user for it
interactively.</p>
<p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password" title="safeguard.sessions.plugin.aa_plugin.AAPlugin._extract_mfa_password"><code class="xref py py-meth docutils literal"><span class="pre">_extract_mfa_password()</span></code></a> method may be overwritten to modify the calculation of the MFA password. For
example to introduce a new key_value_pair that can be the source of the password.</p>
<p>If this method returns None, then AAPlugin automatically asks for the password.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">str or None</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.authenticate">
<code class="descname">authenticate</code><span class="sig-paren">(</span><em>cookie</em>, <em>session_cookie</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.authenticate" title="Permalink to this definition">¶</a></dt>
<dd><p><strong>Should not be modified.</strong></p>
<p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.authenticate"><code class="xref py py-meth docutils literal"><span class="pre">authenticate()</span></code></a> function is called by SPS directly. Should not be modified, see
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authenticate"><code class="xref py py-meth docutils literal"><span class="pre">do_authenticate()</span></code></a> for customization.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.authorize">
<code class="descname">authorize</code><span class="sig-paren">(</span><em>cookie</em>, <em>session_cookie</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.authorize" title="Permalink to this definition">¶</a></dt>
<dd><p><strong>Should not be modified.</strong></p>
<p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.authorize"><code class="xref py py-meth docutils literal"><span class="pre">authorize()</span></code></a> function is called by SPS directly. Should not be modified, see
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_authorize"><code class="xref py py-meth docutils literal"><span class="pre">do_authorize()</span></code></a> for customization.</p>
</dd></dl>

<dl class="method">
<dt id="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_ended">
<code class="descname">session_ended</code><span class="sig-paren">(</span><em>session_id</em>, <em>cookie</em>, <em>session_cookie</em><span class="sig-paren">)</span><a class="headerlink" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_ended" title="Permalink to this definition">¶</a></dt>
<dd><p><strong>Should not be modified.</strong></p>
<p>The <a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.session_ended"><code class="xref py py-meth docutils literal"><span class="pre">session_ended()</span></code></a> function is called by SPS directly. Should not be modified, see
<a class="reference internal" href="#safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended" title="safeguard.sessions.plugin.aa_plugin.AAPlugin.do_session_ended"><code class="xref py py-meth docutils literal"><span class="pre">do_session_ended()</span></code></a> for customization.</p>
</dd></dl>

</dd></dl>

</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="history.html"
                        title="previous chapter">History of releases</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="services.html"
                        title="next chapter">Plugin-sdk services</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="services.html" title="Plugin-sdk services"
             >next</a> |</li>
        <li class="right" >
          <a href="history.html" title="History of releases"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Safeguard for Privileged Sessions Plugin SDK 1.1.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, PAM Integration Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </div>
  </body>
</html>